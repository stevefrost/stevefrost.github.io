<script>
document.addEventListener("DOMContentLoaded", async () => {
  const synth = new Tone.PolySynth(Tone.Synth).toDestination();
  await Tone.start();

  const whiteNotes = [
    { note: "C4", key: "a" },
    { note: "D4", key: "s" },
    { note: "E4", key: "d" },
    { note: "F4", key: "f" },
    { note: "G4", key: "g" },
    { note: "A4", key: "h" },
    { note: "B4", key: "j" },
    { note: "C5", key: "k" }
  ];

  const blackNotes = [
    { note: "C#4", position: 1, key: "w" },
    { note: "D#4", position: 2, key: "e" },
    { note: "F#4", position: 4, key: "t" },
    { note: "G#4", position: 5, key: "y" },
    { note: "A#4", position: 6, key: "u" }
  ];

  const keyboard = document.getElementById("keyboard");

  whiteNotes.forEach(n => {
    const key = document.createElement("div");
    key.className = "key-white";
    key.dataset.note = n.note;
    key.dataset.key = n.key;
    keyboard.appendChild(key);
  });

  blackNotes.forEach(b => {
    const key = document.createElement("div");
    key.className = "key-black";
    key.dataset.note = b.note;
    key.dataset.key = b.key;
    key.style.left = `${b.position * 40 - 10}px`;
    keyboard.appendChild(key);
  });

  const keys = document.querySelectorAll("[data-note]");
  keys.forEach(key => {
    key.addEventListener("mousedown", () => synth.triggerAttack(key.dataset.note));
    key.addEventListener("mouseup", () => synth.triggerRelease(key.dataset.note));
    key.addEventListener("mouseleave", () => synth.triggerRelease(key.dataset.note));
  });

  const keyMap = {};
  keys.forEach(k => keyMap[k.dataset.key] = k.dataset.note);

  const heldKeys = new Set();

  document.addEventListener("keydown", e => {
    if (keyMap[e.key] && !heldKeys.has(e.key)) {
      heldKeys.add(e.key);
      synth.triggerAttack(keyMap[e.key]);
    }
  });

  document.addEventListener("keyup", e => {
    if (keyMap[e.key]) {
      heldKeys.delete(e.key);
      synth.triggerRelease(keyMap[e.key]);
    }
  });
});
</script>
