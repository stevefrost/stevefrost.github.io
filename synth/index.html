<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>88-Key Synth with Envelope</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #keyboard {
      position: relative;
      width: max-content;
      display: flex;
      user-select: none;
    }
    .key-white {
      width: 40px;
      height: 180px;
      background: white;
      border: 1px solid black;
      box-sizing: border-box;
      z-index: 1;
      cursor: pointer;
    }
    .key-black {
      width: 26px;
      height: 110px;
      background: black;
      position: absolute;
      margin-left: -13px;
      z-index: 2;
      cursor: pointer;
      border-radius: 0 0 6px 6px;
      pointer-events: auto;
    }
    #black-keys {
      position: absolute;
      top: 0;
      left: 0;
      height: 110px;
      width: 100%;
      pointer-events: none;
      z-index: 2;
    }
  </style>
</head>
<body class="bg-gray-900 text-white p-10 flex flex-col items-center">
  <h1 class="text-3xl font-bold mb-6">ðŸŽ¹ 88-Key Polyphonic Synth</h1>

  <button id="start-btn" class="mb-4 px-6 py-3 bg-blue-600 rounded hover:bg-blue-700">
    Start Synth ðŸŽµ
  </button>

  <div class="mb-6 flex flex-col sm:flex-row items-center gap-6">
    <label for="oscillator">
      Oscillator:
      <select id="oscillator" class="ml-2 bg-gray-800 text-white rounded px-2 py-1">
        <option value="sine">Sine</option>
        <option value="square">Square</option>
        <option value="triangle">Triangle</option>
        <option value="sawtooth">Sawtooth</option>
      </select>
    </label>

    <label for="attack">
      Attack:
      <input id="attack" type="range" min="0" max="2" step="0.01" value="0.1" class="ml-2 w-32">
    </label>

    <label for="release">
      Release:
      <input id="release" type="range" min="0" max="5" step="0.01" value="1" class="ml-2 w-32">
    </label>
  </div>

  <div id="keyboard-container" class="relative overflow-x-auto w-full max-w-full">
    <div id="keyboard"></div>
    <div id="black-keys"></div>
  </div>

  <script>
    const startBtn = document.getElementById("start-btn");
    const keyboard = document.getElementById("keyboard");
    const blackKeysContainer = document.getElementById("black-keys");
    const oscillatorSelect = document.getElementById("oscillator");
    const attackSlider = document.getElementById("attack");
    const releaseSlider = document.getElementById("release");

    let synth;
    let started = false;

    const NOTES = [
      "A0","A#0","B0",
      "C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1",
      "C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2",
      "C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3",
      "C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4",
      "C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5",
      "C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6",
      "C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7",
      "C8"
    ];

    function isBlackKey(note) {
      return note.includes("#");
    }

    function getWhiteKeys(notes) {
      return notes.filter(n => !isBlackKey(n));
    }

    let whiteKeysIndices = {};

    function createSynth(oscType, attack, release) {
      return new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: oscType },
        envelope: {
          attack: parseFloat(attack),
          decay: 0.1,
          sustain: 0.7,
          release: parseFloat(release)
        }
      }).toDestination();
    }

    function updateSynth() {
      if (synth) {
        synth.dispose();
      }
      synth = createSynth(
        oscillatorSelect.value,
        attackSlider.value,
        releaseSlider.value
      );
    }

    startBtn.addEventListener("click", async () => {
      if (!started) {
        await Tone.start();
        updateSynth();
        buildKeyboard();
        setupKeyboardEvents();
        startBtn.style.display = "none";
        started = true;
      }
    });

    oscillatorSelect.addEventListener("change", updateSynth);
    attackSlider.addEventListener("input", updateSynth);
    releaseSlider.addEventListener("input", updateSynth);

    function buildKeyboard() {
      keyboard.innerHTML = "";
      blackKeysContainer.innerHTML = "";
      whiteKeysIndices = {};

      const whiteKeys = getWhiteKeys(NOTES);

      whiteKeys.forEach((note, index) => {
        whiteKeysIndices[note] = index;

        const key = document.createElement("div");
        key.className = "key-white";
        key.dataset.note = note;
        keyboard.appendChild(key);
      });

      NOTES.forEach((note, i) => {
        if (isBlackKey(note)) {
          let prevWhiteIndex = -1;
          for (let j = i - 1; j >= 0; j--) {
            if (!isBlackKey(NOTES[j])) {
              prevWhiteIndex = whiteKeysIndices[NOTES[j]];
              break;
            }
          }
          if (prevWhiteIndex === -1) return;

          const key = document.createElement("div");
          key.className = "key-black";
          key.dataset.note = note;
          key.style.left = `${prevWhiteIndex * 40 + 30}px`;

          blackKeysContainer.appendChild(key);
        }
      });
    }

    function setupKeyboardEvents() {
      const keys = document.querySelectorAll("[data-note]");

      keys.forEach(key => {
        key.addEventListener("mousedown", () => synth.triggerAttack(key.dataset.note));
        key.addEventListener("mouseup", () => synth.triggerRelease(key.dataset.note));
        key.addEventListener("mouseleave", () => synth.triggerRelease(key.dataset.note));
      });
    }
  </script>
</body>
</html>
